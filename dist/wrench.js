(function(a){function d(a){var b=document.createElement("iframe"),d=this.__queue=[],e=this;b.style.display="none",b.src=c.src.replace(/\/[^\/]+$/,"")+"/wrench.html",b.onload=function(){var c=document.createElement("script");c.src=location.href.replace(/\/[^\/]+$/,"")+a,b.contentDocument.body.appendChild(c),c.onreadystatechange=c.onload=function(){if(!c.readyState||c.readyState==="complete"||c.readyState==="done"){var a=e.__self=b.contentWindow.self;for(var f=0;f<d.length;f++)a.onmessage({data:d[f]});var g=a.__queue;for(f=0;f<g.length;f++)e.onmessage({data:g[f]});a.postMessage=b.contentWindow.postMessage=function(a){e.onmessage({data:a})}}}},document.body.appendChild(b)}function g(a){var b=this;this.worker=a,this.events={},this.fns={},a.onmessage=function(a){b._handleMessage(a.data)}}function h(a,b){return function(){b.emit("__call",a,f.call(arguments))}}var b=window.wrench={init:function(b){return a?new g(new a(b)):new g(new d(b))}},c=document.getElementsByTagName("script");c=c[c.length-1],d.prototype.postMessage=function(a){this.__self?this.__self.onmessage({data:a}):this.__queue.push(a)};var e=1,f=[].slice;g.prototype._decodeArgs=function(a){for(var b=0;b<a.length;b++)typeof a[b]=="string"&&/^__wrenchFunction/.test(a[b])&&(a[b]=h(a[b],this));return a},g.prototype._encodeArgs=function(a){for(var b=0;b<a.length;b++)if(typeof a[b]=="function"){var c="__wrenchFunction"+e++;this.fns[c]=a[b],a[b]=c}return a},g.prototype._handleMessage=function(a){if(a.type==="__call"){this.fns[a.args[0]].apply(this,a.args[1]);return}var b=this.events[a.type];if(!b)return;var c=this._decodeArgs(a.args);if(typeof b=="function")return b.apply(this,c);for(var d=0;d<b.length;d++)b[d].apply(this,c)},g.prototype.emit=function(a,b,c){var d=arguments.length;this.worker.postMessage({type:a,args:this._encodeArgs(d<2?[]:d<3?[b]:d<4?[b,c]:f.call(arguments,1))})},g.prototype.on=function(a,b){var c=this.events,d=typeof c[a];d==="undefined"?c[a]=b:d==="function"?c[a]=[c[a],b]:c[a].push(b)}})(typeof Worker=="function"?Worker:!1);